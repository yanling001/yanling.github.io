# 1. OAuth协议产生背景
#### &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;很多网站，App弱化甚至没有搭建自己的账号体系，而是直接使用第三方登录的方式，这样不仅免去了用户注册账号的麻烦，还可以获取用户的一些信息，增强自身的功能。
#### &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;例如用微博登录简书，简书会自动将你的微博头像设置为你的简书头像，将微博呢称设置为简书昵称，甚至可以获取你微博中的好友列表，提示你哪些朋友已经在使用简书。
#### &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;最传统的方法是让用户直接在简书的登录页面输入微博的账号和密码，简书通过用户的账号和密码去微博获取用户数据，这样有很多缺点：
1. 简述需要铭文保存用户的微博账号和密码，这样很不安全；
2. 简书拥有了获取用户在微博的所有权限，包括删除好友，给好友发私信，更改密码，注销账号等一系列危险的操作；
3. 用户只有修改密码，才能收回赋予简书的权限，但这样做会使得其他所有获得用户授权的第三方应用程序全部失效；
4. 只要有一个第三方应用程序被破解，就会导致用户密码泄漏，以及所有使用微博登录的网站的数据泄漏；
#### 为了解决以上的问题，OAuth协议产生了。
# 2. 定义
#### &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OAuth（开放授权）是一个关于授权的开放的网络协议；
#### &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;允许用户让第三方应用访问该用户在某一网站上存储的资源（如：图片，视频，联系人等），而无需将用户名和密码提供给第三方应用；
#### &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OAuth是一个关于授权的开放网络标准，目前的版本是2.0版。

# 3. 基本原理
#### OAuth在第三方应用与服务提供商之间设置了一个授权层。第三方应用不能直接登录提供商，只能登录授权层，以此将用户与客户端区分开来。第三方应用登录授权层所用的令牌，与用户的密码不同。用户可以在登录授权的时候，指定授权层令牌的权限范围和有效期。
#### &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;第三方应用登录授权层后，服务提供商根据令牌的权限范围和有效期，向第三方应用开放用户资源。

# 4. 作用
#### 让客户端安全可控地获取用户的授权，与服务商之间进行交互。可以免去用户同步的麻烦，同时也增加了用户信息安全。

# 5. changing应用场景
#### 1. 用OAuth来实现第三方应用对API的访问控制；
#### 2. 登录第三方应用时，经常会采用其他用户登录的方式，比如QQ，微博，微信等授权登录；

# 6. 协议流程
#### （A）用户打开客户端以后，客户端要求用户给予授权；
#### （B）用户同意给予客户端授权；
#### （C）客户端使用上一步获得的授权，向认证服务器申请令牌；
#### （D）认证服务器对客户端进行认证后，确认无误，同意发放令牌；
#### （E）客户端使用令牌，向资源服务器申请获取资源；
#### （F）资源服务器确认令牌无误，同意向客户端开放资源；

# 7. 客户端授权模式
#### &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;客户端必须得到用户的授权，才能获得令牌。OAuth定义了四种授权方式：授权码模式，简化模式，密码模式，客户端模式。

## （1）授权码模式
#### &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;功能最完整，流程最严密的授权模式。它的特点就是通过客户端的后台服务器，与服务提供商的认证服务器进行互动；
## （2）简化模式
#### &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;不通过第三方应用程序的服务器，直接在浏览器中向认证服务器申请令牌，跳过了“授权”这个步骤。所有步骤在浏览器中完成，令牌对访问者是可见的，且客户端不需要认证。
## （3）密码模式
#### &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;用户向客户端提供自己的用户名和密码。客户端使用这些信息，向“服务提供商”所要授权。在这种模式中，用户必须把自己的密码给客户端，但是客户端不得存储密码。这通常用在用户对客户端高度信任的情况下，比如客户端是操作系统的一部分，或者由一个著名公司出品。而认证服务器只有在其他授权模式下无法执行的情况下，才能考虑使用这种模式。
## （4）客户端模式
#### &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;指客户端以自己的名义，而不是以用户的名义，向“服务提供商”进行认证。严格的说，客户端模式并不属于OAuth框架所需要解决的问题。在这种模式中，用户直接向客户端进行注册，客户端以自己的名义要求“服务提供商”提供服务，其实不存在授权问题。

# 8. 授权码模式
## 8.1 原理概要：
#### &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;新浪微博作为服务提供商，拥有用户头像，昵称，邮箱，好友以及所有的微博内容，简书希望获取用户存储在微博的头像和昵称，假设是三个人：
1. 简书问新浪微博：我想要获取用户A的头像和昵称，请你提供；
2. 微博说：我需要经过用户A本人的许可，然后去问用户A是否要授权简书访问自己的头像和昵称；
3. 用户A对微博说：我给简书一个临时钥匙，如果它出示了这把钥匙，你就把我的资料给它；
4. 简书使用用户给它的钥匙去向微博所要用户的头像和昵称；

## 8.2 详细流程
![image](http://note.youdao.com/yws/res/26071/D9B6D7325BAA42EAB5D41368F7FEB2A8)

### 1. 用户点击简书上的微博登录按钮，跳转到微博授权页面。微博登录按钮的连接形式如下方的URL：

```
 https://api.weibo.com/oauth2/authorize?client_id=123050457758183&redirect_uri=http://jianshu.com/callback
```
#### URL中包含以下参数：
1. client_id：微博开放平台申请的应用ID；
2. redirect_uri：授权成功后要跳转到的地址；
#### 点击以上连接后跳转到微博的授权登录页面：

![image](http://note.youdao.com/yws/res/26081/44FCA927D32949389D2F2731FA42C78F)

#### 这个页面会告诉用户第三方应用要获取用户的哪些数据，以及拥有什么权限，比如在上图中简书会要求获得个人信息，好友关系，分享内容到微博以及获得评论的权限，用户点击“允许”则表示允许简书获得这些数据。

### 2. 页面自动跳转到初始参数中redirect_uri定义的那个URL，并自动在UERL末尾添加一个code参数，实际跳转的地形如：

```
http://jianshu.com/callback?code=2559200ecd7ea433f067a2cf67d6ce6c
```
### 3. 第三步，简书通过上一步获取的code参数换取Token，Token就是所说的令牌。简书请求如下的接口获取Token：
#### POST https://api.weibo.com/oauth2/access_token要包含以下参数：
- client_id：在微博平台申请的应用ID；
- client_secret：在微博开放平台申请时提供的APP Secret
- grant_type：需要填写authorization_code；
- code：上一步获得得code；
- redirect_uri：毁掉地址，需要与注册应用里得回调地址以及第一步得redirect_uri参数一致；
#### 注意：获取token十分重要，采用POST方式比较安全

### 4. 通过第三步得请求，接口返回Token和相关数据：

```
{
 "access_token": "ACCESS_TOKEN",//Token 的值
 "expires_in": 1234,//过期时间
 "uid":"12341234"//当前授权用户的UID。
}
```
### 5. 在第四步中获取了access_token，使用它，就可以去获取用户资源了，要获取用户昵称和头像，访问开放平台接口；
- 携带上一步获取得access_token去获取数据；
#### 注意：access_token使用时间有限，若失效，常用办法：
- 重新授权登录；
- 使用refresh_token，重新申请；
### 6. 最后一步，微博返回用户信息，简书进行处理，整个流程结束；
#### &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;通过以上方式，在简书和新浪微博中间建立了一个独立得权限层，这个权限由用户赋予，可以被取消，不同第三方应用之间互相独立，互不干扰，这样就彻底解决了明文存放账号密码的问题。
